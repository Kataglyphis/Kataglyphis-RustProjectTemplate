[package]
name = "kataglyphis_rustprojecttemplate"
version = "0.1.0"
edition = "2024"
license = "UNLICENSED"
repository = "https://github.com/Kataglyphis/Kataglyphis-RustProjectTemplate"
description = "Rust project template with optional GUI, ONNX backends, profiling, packaging, and CI workflows."
readme = "README.md"
rust-version = "1.85"

[lib]
name = "kataglyphis_rustprojecttemplate"
crate-type = ["cdylib", "staticlib", "rlib"]

[features]
# CLI-only by default to avoid GTK/GStreamer on Windows.
default = []
gui = ["dep:gstreamer", "dep:gstreamer-video", "dep:glib"]
gui_unix = ["gui", "dep:gtk"]
gui_linux = ["gui_windows"]
gui_windows = [
	"gui",
	"dep:gstreamer-app",
	"dep:winit",
	"dep:wgpu",
	"dep:pollster",
	"dep:bytemuck",
	"dep:egui",
	"dep:egui-winit",
	"dep:egui-wgpu",
	"onnx_tract",
]

# Pure-Rust ONNX backend (CPU) via tract.
onnx_tract = ["dep:tract-onnx", "dep:image"]

# Optional ONNX Runtime backend (Windows): enables GPU inference via DirectML when available.
onnxruntime = ["dep:ort", "dep:image", "ort/std", "ort/ndarray", "ort/download-binaries", "ort/tls-native"]
onnxruntime_directml = ["onnxruntime", "ort/directml"]
onnxruntime_cuda = ["onnxruntime", "ort/cuda"]

# Prototyping playground: Burn demos + optional ONNX Runtime demo.
# Kept behind a feature so the template stays lightweight by default.
burn_demos = [
	"dep:burn",
	"dep:burn-autodiff",
	"dep:burn-ndarray",
	"dep:ndarray",
	"dep:plotters",
	"onnxruntime",
]

[dependencies]
flutter_rust_bridge = "=2.11.1"
anyhow = "1"
log = "0.4"
env_logger = "0.11.9"
chrono = "0.4"
clap = { version = "4", features = ["derive"] }
sysinfo = "0.38"
gtk = { version = "0.10", package = "gtk4", features = ["v4_10"], optional = true }
gstreamer = { version = "0.24.4", optional = true }
gstreamer-video = { version = "0.24.4", optional = true }
glib = { version = "0.21.5", optional = true }
gstreamer-app = { version = "0.24.4", optional = true }
winit = { version = "0.30", optional = true }
wgpu = { version = "27.0.1", optional = true }
gpu-allocator = { version = "0.28.0", default-features = false, features = ["std"] }
pollster = { version = "0.4", optional = true }
bytemuck = { version = "1.25", features = ["derive"], optional = true }
egui = { version = "0.33.3", optional = true }
egui-winit = { version = "0.33.3", optional = true }
egui-wgpu = { version = "0.33.3", optional = true }

# ONNX inference (optional)
tract-onnx = { version = "0.22", optional = true }
image = { version = "0.25", default-features = false, features = ["png", "jpeg"], optional = true }
ort = { version = "=2.0.0-rc.11", optional = true, default-features = false }

# Burn demos (optional)
burn = { version = "0.20.1", default-features = false, features = ["std", "ndarray", "autodiff"], optional = true }
burn-autodiff = { version = "0.20.1", optional = true }
burn-ndarray = { version = "0.20.1", optional = true }
ndarray = { version = "0.17", optional = true }
plotters = { version = "0.3", optional = true }

# Tokio on wasm only supports a small subset of features.
[target.'cfg(not(target_arch = "wasm32"))'.dependencies]
tokio = { version = "1", features = ["fs", "macros", "rt-multi-thread", "time"] }

[target.'cfg(target_arch = "wasm32")'.dependencies]
tokio = { version = "1", default-features = false, features = ["macros", "rt", "time", "sync"] }

[target.'cfg(windows)'.dependencies]
serde = { version = "1", features = ["derive"] }
wmi = "0.18"

[lints.rust]
# `flutter_rust_bridge::frb` uses `cfg(frb_expand)` internally; declare it so Rust's
# `unexpected_cfgs` lint doesn't warn.
unexpected_cfgs = { level = "warn", check-cfg = ['cfg(frb_expand)'] }

[dev-dependencies]
assert_cmd = "2"
predicates = "3"
tempfile = "3"

[patch.crates-io]
gpu-allocator = { git = "https://github.com/Traverse-Research/gpu-allocator", branch = "main" }

[[bin]]
name = "burn-demos"
path = "src/bin/burn_demos.rs"
required-features = ["burn_demos"]
