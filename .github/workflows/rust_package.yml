name: Build app

on:
  workflow_call:
    inputs:
      runner:
        required: true
        type: string         # e.g. 'ubuntu-24.04'
      project_dir:
        required: true
        type: string         # path to your Rust project, e.g. 'kataglyphis-rustprojecttemplate'
      binary_name:
        required: true
        type: string         # name of the built binary, e.g. 'kataglyphis-rustprojecttemplate'

jobs:
  build-app:
    name: Build and package ${{ inputs.binary_name }}
    runs-on: ${{ inputs.runner }}
    env:
      PROJECT_DIR: ${{ inputs.project_dir }}
      BINARY: ${{ inputs.binary_name }}
      VERSION: ${{ github.ref_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: 🛠️ Build release binary
        run: |
          cd "$PROJECT_DIR"
          cargo build --release

      - name: 📦 Prepare archive variables
        id: vars
        run: |
          ARCHIVE_NAME="${BINARY}-${VERSION}-${RUNNER_OS}.tar.gz"
          echo "archive_name=$ARCHIVE_NAME" >> "$GITHUB_OUTPUT"

      - name: 📦 Create archive
        shell: bash
        run: |
          cd "$PROJECT_DIR"
          mkdir -p dist
          cp "target/release/$BINARY" dist/
          tar czvf "dist/${{ steps.vars.outputs.archive_name }}" -C dist "$BINARY"

      - name: 📤 Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.binary_name }}-${{ github.ref_name }}-${{ inputs.runner }}
          path: ${{ inputs.project_dir }}/dist/${{ steps.vars.outputs.archive_name }}
