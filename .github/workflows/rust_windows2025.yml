name: Rust workflow on Windows 2025
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  windows-pipeline:
    if: ${{ github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message || '', '[build-win]') }}
    name: Build, test, and package (windows-2025)
    runs-on: windows-2025
    env:
      BINARY: kataglyphis_rustprojecttemplate
      VERSION: ${{ github.ref_name }}

    steps:
      - name: Enable Git long paths
        run: git config --global core.longpaths true
        shell: pwsh

      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Cleanup disk space
        uses: ./.github/actions/cleanup-disk-space

      - name: Login to GitHub
        uses: docker/login-action@v3.7.0
        with:
          registry: ghcr.io
          username: Kataglyphis
          password: ${{ secrets.GHCR_PAT }}

      - name: Pull image
        run: |
          docker pull ghcr.io/kataglyphis/kataglyphis_beschleuniger:winamd64 

      - name: Run build inside container
        shell: pwsh
        run: |
          # 1. Run Docker with EncodedCommand
          docker run --rm `
            --env BINARY="${{ env.BINARY }}" `
            --env VERSION="${{ env.VERSION }}" `
            --mount "type=bind,source=${{ github.workspace }},target=C:\workspace" `
            -w "C:\workspace" `
            ghcr.io/kataglyphis/kataglyphis_beschleuniger:winamd64 `
            powershell -NoProfile -ExecutionPolicy Bypass -File "C:\workspace\scripts\windows\build-windows.ps1"

      - name: ðŸ“¦ Prepare archive variables
        id: vars
        shell: pwsh
        run: |
          $archive = "$env:BINARY-$env:VERSION-windows-2025-x64.zip"
          echo "archive_name=$archive" >> $env:GITHUB_OUTPUT

      - name: ðŸ“¦ Create archive
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Compress-Archive -Path "target/release/$env:BINARY.exe" -DestinationPath "dist/${{ steps.vars.outputs.archive_name }}" -Force

      - name: ðŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: ${{ env.BINARY }}-${{ github.ref_name }}-windows-2025-x64
          path: dist/${{ steps.vars.outputs.archive_name }}
